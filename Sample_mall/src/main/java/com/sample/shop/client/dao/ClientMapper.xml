<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sample.shop.client.dao.ClientMapper">
	
	<select id="getProdListNew" resultType="prodVO">
		SELECT p_no, p_name, to_char(p_price,'999G999G999')
		AS p_price, p_mainimg, stock FROM prod WHERE p_salecnt >= 300
	</select>
	
	<select id="getMainImages" resultType="mainImgVO">
		SELECT m_no, m_imgname FROM mall_mainimage
	</select>

	<select id="getProdList" resultType="com.sample.shop.model.prodVO">
	<![CDATA[
		select p_no, p_name, to_char(p_price,'999G999G999')
		as p_price, p_mainimg, stock from prod 
		]]>
	</select>
	
	<select id="getProdDetail" resultType="prodVO">
		SELECT P_NAME, to_char(p_price, '999G999G999') AS p_price, P_INFO, P_NO, p_mainimg, stock FROM PROD WHERE P_NO = #{P_NO}
	</select>
	
	<select id="getDetailImage" resultType="prodVO">
		SELECT p_no, p_detailimg FROM prod_detailimg WHERE p_no = #{p_no}
	</select>
	
	<select id="getBoardList" resultType="boardVO">
		SELECT b_no, b_title, to_char(b_regdate,'YY.MM.DD') as b_regdate, b_type FROM mall_board
		ORDER BY b_no DESC
	</select>
	
	<select id="boardDetail" resultType="boardVO">
		SELECT b_no, b_title, b_content, to_char(b_regdate,'YY.MM.DD') as b_regdate, b_type
		FROM mall_board WHERE b_no = #{b_no}
	</select>
	
	<insert id="boardWrite">
		INSERT INTO mall_board
		(b_no, b_title, b_content, b_type)
		VALUES
		(seq_mall_board.nextval, #{b_title}, #{b_content}, #{b_type})
	</insert>
	
	<insert id="userJoin">
		INSERT INTO mall_user
		(u_no, u_id, u_pw, u_name, u_mainaddress, u_subaddress, u_birth, u_phone
		, u_findpw_question, u_findpw_answer, u_auth)
		values
		(seq_mall_user.nextval, #{u_id}, #{u_pw}, #{u_name}, #{u_mainaddress}, #{u_subaddress}
		,#{u_birth},#{u_phone},#{u_findpw_question},#{u_findpw_answer},#{u_auth})
	</insert>
	
	<select id="getMainTypeList" resultType="prodVO">
		SELECT p_no, p_name, to_char(p_price, '999G999G999') AS p_price, p_mainimg, stock
		FROM prod WHERE p_maintype = #{mainType}
	</select>
	
	<select id="searchItems" resultType="prodVO">
		SELECT p_no, p_name, to_char(p_price, '999G999G999') AS p_price, p_mainimg, stock
		FROM prod WHERE p_name LIKE '%'||#{searchKeyword}||'%'
		OR p_info LIKE '%'||#{searchKeyword}||'%'
	</select>
	
	<select id="userInfo" resultType="userVO">
		SELECT * FROM mall_user WHERE u_id = #{u_id}
	</select>
	
	<update id="userInfoUpdate">
		UPDATE mall_user SET u_name = #{u_name}, u_mainaddress = #{u_mainaddress}, u_subaddress = #{u_subaddress}
		, u_phone = #{u_phone}, u_birth = #{u_birth} WHERE u_no = #{u_no}
	</update>
	
	<insert id="cartInsert">
		INSERT INTO mall_cart
		(c_no,u_no, p_no, amount)
		VALUES
		((SELECT NVL(MAX(c_no), 0) + 1 FROM mall_cart WHERE u_no = (SELECT u_no FROM mall_user WHERE u_id = #{u_id}))
		,(SELECT u_no FROM mall_user WHERE u_id = #{u_id}),#{p_no}, #{amount})
	</insert>
	
	<select id="getCartList" resultType="cartVO">
		SELECT c.c_no, p.p_name, to_char(p.p_price, '999G999G999') AS p_price, c.amount, c.p_no, (SELECT u_no FROM mall_user WHERE u_id = #{u_id}) AS u_no 
		FROM prod p, mall_cart c WHERE p.p_no = c.p_no
	</select>
	
	<select id="bestItemList" resultType="prodVO">
	<![CDATA[
		SELECT * FROM (SELECT p_no, p_name, to_char(p_price, '999G999G999') AS p_price, p_mainimg, stock FROM prod WHERE p_salecnt >= 100) 
        WHERE ROWNUM <= 100
    ]]>
	</select>
	
	<insert id="wishInsert">
		INSERT INTO mall_wishlist
		(w_no, u_no, p_no)
		VALUES
		((SELECT NVL(MAX(w_no), 0) + 1 FROM mall_wishlist WHERE u_no = (SELECT u_no FROM mall_user WHERE u_id = #{u_id}))
		, (SELECT u_no FROM mall_user WHERE u_id = #{u_id}), #{p_no})
	</insert>
	
	<select id="getUserNo" resultType="_int">
		SELECT u_no FROM mall_user WHERE u_id = #{u_id}
	</select>
	
	<insert id="buyProduct">
		INSERT INTO prod_buy
		(b_no, b_u_no, b_p_no, b_p_name, b_amount, b_receivername, b_receiverphone, b_address)
		VALUES
		(#{b_no}, #{b_u_no}, #{b_p_no}, #{b_p_name}, #{b_amount}, #{b_receivername}, #{b_receiverphone}, #{b_address})
	</insert>
	
	<select id="getPurchaseInfo" resultType="purchaseVO">
		SELECT b_no, (SELECT u_name FROM mall_user WHERE u_no = #{b_u_no}) as b_u_name, b_p_no, b_p_name, 
		b_amount, b_receivername, b_receiverphone, b_paytype, to_char(b_regdate, 'YYYYMMDD') as b_regdate, 
		b_paytotal, b_address, b_savingpoint FROM prod_buy WHERE b_no = #{b_no}
	</select>
	
	<select id="getPurchaseList" resultType="purchaseVO">
		SELECT b_no, b_p_name, b_paytype, to_char(b_regdate, 'YYYYMMDD') as b_regdate FROM prod_buy WHERE b_u_no = #{u_no}
	</select>
	
	<update id="doMinusStock">
		UPDATE prod SET stock = stock - #{stock} WHERE p_no = #{p_no}
	</update>
	
</mapper>